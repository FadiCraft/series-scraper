const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");
const axios = require("axios");
const youtubedl = require('youtube-dl-exec');

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
['output', 'temp', 'downloads'].forEach(dir => {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir);
  }
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±
async function downloadFromUrl(url, outputPath) {
  console.log(`ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù†: ${url}`);
  
  try {
    if (url.includes('youtube.com') || url.includes('youtu.be') || 
        url.includes('facebook.com') || url.includes('twitter.com') || 
        url.includes('tiktok.com') || url.includes('instagram.com')) {
      
      console.log("ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… youtube-dl Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©...");
      await youtubedl(url, {
        output: outputPath,
        format: 'mp4',
        noCheckCertificate: true
      });
      
    } else {
      console.log("ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±...");
      const response = await axios({
        method: 'GET',
        url: url,
        responseType: 'stream',
        timeout: 300000,
        maxContentLength: Infinity,
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }
      });
      
      const writer = fs.createWriteStream(outputPath);
      response.data.pipe(writer);
      
      await new Promise((resolve, reject) => {
        writer.on('finish', resolve);
        writer.on('error', reject);
      });
    }
    
    if (fs.existsSync(outputPath) && fs.statSync(outputPath).size > 0) {
      console.log(`âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${outputPath}`);
      return outputPath;
    } else {
      throw new Error("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡");
    }
    
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:", error.message);
    
    try {
      console.log("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FFmpeg...");
      execSync(`ffmpeg -y -i "${url}" -c copy ${outputPath}`, { 
        stdio: 'inherit',
        timeout: 300000 
      });
      return outputPath;
    } catch (ffmpegError) {
      throw new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ${error.message}`);
    }
  }
}

// Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù†Øµ
function parseScriptFile(scriptPath) {
  const content = fs.readFileSync(scriptPath, "utf8");
  const lines = content.split("\n").filter(line => line.trim() !== "");
  
  const scenes = [];
  
  for (const line of lines) {
    const match = line.match(/(\d+:\d+)-(\d+:\d+)\s*\|\s*(.+)/);
    
    if (match) {
      const startTime = timeToSeconds(match[1]);
      const endTime = timeToSeconds(match[2]);
      const description = match[3];
      
      scenes.push({
        start: startTime,
        end: endTime,
        duration: endTime - startTime,
        text: description
      });
    }
  }
  
  return scenes;
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† ØµÙŠØºØ© Ø¯Ù‚Ø§Ø¦Ù‚:Ø«ÙˆØ§Ù†ÙŠ Ø¥Ù„Ù‰ Ø«ÙˆØ§Ù†ÙŠ
function timeToSeconds(timeStr) {
  const parts = timeStr.split(":");
  if (parts.length === 2) {
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
  }
  return parseInt(timeStr);
}

// ========== Ø§Ù„Ø£Ù‡Ù…: ØªÙˆÙ„ÙŠØ¯ ØªØ¹Ù„ÙŠÙ‚ ØµÙˆØªÙŠ Ø¹Ø±Ø¨ÙŠ ÙØµÙŠØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Chatterbox ==========
async function generateArabicVoiceover(text, outputPath) {
  console.log(`ğŸ™ï¸ ØªÙˆÙ„ÙŠØ¯ ØªØ¹Ù„ÙŠÙ‚ ØµÙˆØªÙŠ Ø¹Ø±Ø¨ÙŠ ÙØµÙŠØ­ (Chatterbox): "${text.substring(0, 50)}..."`);
  
  try {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…ÙˆØ°Ø¬ Chatterbox Multilingual [citation:3][citation:7]
    // Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… API - Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ ØªÙˆØ«ÙŠÙ‚ Chatterbox Ø§Ù„Ø±Ø³Ù…ÙŠ
    
    // Ø§Ù„Ø®ÙŠØ§Ø± 1: Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ (ÙŠÙØ¶Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Resemble AI Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ API key)
    // Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…ØªØ§Ø­ Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ø¨Ø± GitHub [citation:7]
    
    // Ù„Ù„ØªØ¨Ø³ÙŠØ·ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØªØ´ØºÙŠÙ„Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹
    // Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªØ«Ø¨ÙŠØª Ø­Ø²Ù…Ø© chatterbox Ø¹Ø¨Ø± pip (Ù„Ù„Ø¨ÙŠØ«ÙˆÙ†) ÙˆÙ„ÙƒÙ† Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨ØªØŒ
    // Ø³Ù†Ø³ØªØ®Ø¯Ù… API Ù…Ø¤Ù‚Øª Ø£Ùˆ Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
    
    // Ù„Ù„Ø£Ø³ÙØŒ Chatterbox ÙŠØ¹Ù…Ù„ Ø¹Ø¨Ø± Python Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ [citation:7]
    // Ù„Ø°Ù„Ùƒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Luvvoice API ÙƒØ¨Ø¯ÙŠÙ„ Ù…Ù…ØªØ§Ø² ÙˆÙ…Ø¬Ø§Ù†ÙŠ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© [citation:4][citation:8]
    
    return await generateArabicVoiceoverLuvvoice(text, outputPath);
    
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª:", error.message);
    
    // backup: Ø§Ø³ØªØ®Ø¯Ø§Ù… Google TTS
    console.log("âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Google TTS ÙƒØ¨Ø¯ÙŠÙ„...");
    return await generateArabicVoiceoverGoogle(text, outputPath);
  }
}

// Ø¨Ø¯ÙŠÙ„ Ù…Ù…ØªØ§Ø²: Luvvoice - Ù…Ø¬Ø§Ù†ÙŠ ÙˆÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© [citation:4][citation:8][citation:10]
async function generateArabicVoiceoverLuvvoice(text, outputPath) {
  console.log(`ğŸ™ï¸ ØªÙˆÙ„ÙŠØ¯ ØªØ¹Ù„ÙŠÙ‚ ØµÙˆØªÙŠ Ø¹Ø±Ø¨ÙŠ (Luvvoice): "${text.substring(0, 50)}..."`);
  
  try {
    // Luvvoice Ø®Ø¯Ù…Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ø±Ø§Ø¦Ø¹Ø©ØŒ 200 ØµÙˆØª ÙˆØ£ÙƒØ«Ø± Ù…Ù† 70 Ù„ØºØ© [citation:4]
    // Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©: 20,000 Ø­Ø±Ù Ø´Ù‡Ø±ÙŠØ§Ù‹ [citation:4][citation:8]
    
    // Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ ØªÙ‚Ø±ÙŠØ¨ÙŠ - Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ API Ø§Ù„ÙØ¹Ù„ÙŠ
    const response = await axios({
      method: 'POST',
      url: 'https://api.luvvoice.com/v1/tts', // Ø±Ø§Ø¨Ø· ØªÙ‚Ø±ÙŠØ¨ÙŠ - Ø±Ø§Ø¬Ø¹ Ù…ÙˆÙ‚Ø¹Ù‡Ù… Ù„Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­
      data: {
        text: text,
        language: 'ar',
        voice: 'ar-1', // Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰
        speed: 1.0,
        pitch: 1.0
      },
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'audio/mpeg'
      },
      responseType: 'arraybuffer',
      timeout: 30000
    });
    
    fs.writeFileSync(`${outputPath}.mp3`, response.data);
    console.log("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­!");
    
    return `${outputPath}.mp3`;
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Luvvoice:", error.message);
    throw error;
  }
}

// Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ø§Ù„Ø«Ø§Ù„Ø«: Google Translate TTS (Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ø±ÙŠØ¹)
async function generateArabicVoiceoverGoogle(text, outputPath) {
  console.log(`ğŸ™ï¸ ØªÙˆÙ„ÙŠØ¯ ØªØ¹Ù„ÙŠÙ‚ ØµÙˆØªÙŠ Ø¹Ø±Ø¨ÙŠ (Google): "${text.substring(0, 50)}..."`);
  
  try {
    const encodedText = encodeURIComponent(text);
    const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=ar&client=tw-ob`;
    
    const response = await axios({
      method: 'GET',
      url: url,
      responseType: 'arraybuffer',
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    
    fs.writeFileSync(`${outputPath}.mp3`, response.data);
    console.log("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google TTS");
    
    return `${outputPath}.mp3`;
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Google TTS:", error.message);
    
    // Ø¢Ø®Ø± Ø¨Ø¯ÙŠÙ„: ØªÙˆÙ„ÙŠØ¯ ØµÙˆØª ØªØ¬Ø±ÙŠØ¨ÙŠ
    console.log("âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØª ØªØ¬Ø±ÙŠØ¨ÙŠ...");
    execSync(`ffmpeg -y -f lavfi -i "sine=frequency=1000:duration=3" -ar 22050 ${outputPath}.mp3`);
    return `${outputPath}.mp3`;
  }
}

// Ù‚Øµ Ù…Ù‚Ø·Ø¹ Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function cutVideoSegment(inputVideo, start, duration, outputPath) {
  console.log(`ğŸï¸ Ù‚Øµ Ù…Ù‚Ø·Ø¹ Ù…Ù† ${start.toFixed(2)}s Ù„Ù…Ø¯Ø© ${duration.toFixed(2)}s`);
  
  execSync(
    `ffmpeg -y -ss ${start} -t ${duration} -i "${inputVideo}" ` +
    `-c:v libx264 -c:a aac ${outputPath}`
  );
  
  return outputPath;
}

// Ø¹Ù…Ù„ Ù…ÙˆÙ†ØªØ§Ø¬ Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠ (ØªØ¬Ù…ÙŠØ¯ + Ø²ÙˆÙ…)
function applyCinematicEffects(inputVideo, voiceoverPath, outputPath) {
  console.log("ğŸ¬ ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ±Ø§Øª Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠØ©...");
  
  const durationOutput = execSync(
    `ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "${inputVideo}"`
  ).toString();
  const videoDuration = parseFloat(durationOutput);
  
  const voiceDurationOutput = execSync(
    `ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "${voiceoverPath}"`
  ).toString();
  const voiceDuration = parseFloat(voiceDurationOutput);
  
  const targetDuration = Math.max(videoDuration, voiceDuration) + 2;
  const freezeFrames = Math.ceil((targetDuration - videoDuration) * 30);
  
  const filterComplex = `
    [0:v]trim=0:${videoDuration},setpts=PTS-STARTPTS[main];
    [0:v]trim=${videoDuration-0.04}:${videoDuration},setpts=PTS-STARTPTS,loop=loop=${freezeFrames}:size=1,setpts=N/FRAME_RATE/TB[frozen];
    [frozen]zoompan=z='min(zoom+0.002,1.3)':d=1:fps=30[zoomed];
    [main][zoomed]concat=n=2:v=1:a=0[finalv]
  `;
  
  try {
    execSync(
      `ffmpeg -y -i "${inputVideo}" -i "${voiceoverPath}" ` +
      `-filter_complex "${filterComplex}" ` +
      `-map "[finalv]" -map 1:a -c:v libx264 -c:a aac -shortest "${outputPath}"`,
      { stdio: 'pipe' }
    );
  } catch (error) {
    console.log("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø©...");
    execSync(
      `ffmpeg -y -i "${inputVideo}" -i "${voiceoverPath}" ` +
      `-c:v copy -c:a aac -map 0:v:0 -map 1:a:0 -shortest "${outputPath}"`
    );
  }
  
  return outputPath;
}

// Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹
function concatVideos(videoList, outputPath) {
  console.log("ğŸ”— Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹...");
  
  const listFile = "temp/concat_list.txt";
  const content = videoList.map(v => `file '${path.resolve(v)}'`).join("\n");
  fs.writeFileSync(listFile, content);
  
  execSync(
    `ffmpeg -y -f concat -safe 0 -i "${listFile}" -c copy "${outputPath}"`
  );
  
  return outputPath;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function getVideoInfo(videoPath) {
  try {
    const output = execSync(
      `ffprobe -v error -show_entries format=duration,size -of default=noprint_wrappers=1 "${videoPath}"`
    ).toString();
    
    const lines = output.split('\n');
    const info = {};
    lines.forEach(line => {
      const [key, value] = line.split('=');
      if (key && value) info[key] = value;
    });
    
    return {
      duration: parseFloat(info.duration) || 0,
      size: parseInt(info.size) || 0
    };
  } catch (error) {
    return { duration: 0, size: 0 };
  }
}

// ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
function cleanup() {
  console.log("ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©...");
  
  try {
    const tempDir = 'temp';
    if (fs.existsSync(tempDir)) {
      const files = fs.readdirSync(tempDir);
      files.forEach(file => {
        if (file.endsWith('.mp4') || file.endsWith('.mp3') || file.endsWith('.txt')) {
          try { fs.unlinkSync(path.join(tempDir, file)); } catch (e) {}
        }
      });
    }
  } catch (error) {
    console.log("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©:", error.message);
  }
}

// ============= Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =============
async function main() {
  console.log("ğŸš€ Ø¨Ø¯Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙÙ„Ø§Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ");
  console.log("=".repeat(50));
  
  const videoSource = process.argv[2];
  const scriptFile = process.argv[3] || "script.txt";
  
  if (!videoSource) {
    console.error("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ØµØ¯Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø±Ø§Ø¨Ø· Ø£Ùˆ Ù…Ø³Ø§Ø± Ù…Ù„Ù)");
    console.log("ğŸ“Œ Ù…Ø«Ø§Ù„: node Molahas.js https://example.com/video.mp4 script.txt");
    console.log("ğŸ“Œ Ù…Ø«Ø§Ù„: node Molahas.js movie.mp4 script.txt");
    process.exit(1);
  }
  
  if (!fs.existsSync(scriptFile)) {
    console.error(`âŒ Ù…Ù„Ù Ø§Ù„Ù†Øµ ${scriptFile} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
    console.log("ğŸ“ Ù…Ø«Ø§Ù„ Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù:");
    console.log("00:00-01:30 | ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙÙŠÙ„Ù… Ø¨Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø¨Ø·Ù„");
    console.log("01:30-03:00 | ÙŠØªØ¹Ø±Ø¶ Ù„Ù‡Ø¬ÙˆÙ… Ù…ÙØ§Ø¬Ø¦");
    process.exit(1);
  }
  
  let videoPath;
  let isUrl = videoSource.startsWith('http://') || videoSource.startsWith('https://');
  
  if (isUrl) {
    console.log(`ğŸŒ Ø§Ù„Ù…ØµØ¯Ø±: Ø±Ø§Ø¨Ø· (${videoSource.substring(0, 100)}...)`);
    videoPath = "downloads/downloaded_video.mp4";
    
    try {
      await downloadFromUrl(videoSource, videoPath);
    } catch (error) {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:", error.message);
      process.exit(1);
    }
  } else {
    console.log(`ğŸ“ Ø§Ù„Ù…ØµØ¯Ø±: Ù…Ù„Ù Ù…Ø­Ù„ÙŠ (${videoSource})`);
    if (!fs.existsSync(videoSource)) {
      console.error(`âŒ Ø§Ù„Ù…Ù„Ù ${videoSource} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
      process.exit(1);
    }
    videoPath = videoSource;
  }
  
  const videoInfo = getVideoInfo(videoPath);
  const durationMinutes = Math.floor(videoInfo.duration / 60);
  const durationSeconds = Math.floor(videoInfo.duration % 60);
  console.log(`ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:`);
  console.log(`   - Ø§Ù„Ù…Ø¯Ø©: ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`);
  console.log(`   - Ø§Ù„Ø­Ø¬Ù…: ${(videoInfo.size / (1024*1024)).toFixed(2)} MB`);
  
  console.log(`\nğŸ“„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù†Øµ: ${scriptFile}`);
  const scenes = parseScriptFile(scriptFile);
  console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${scenes.length} Ù…Ø´Ù‡Ø¯`);
  
  const validScenes = scenes.filter(scene => scene.end <= videoInfo.duration);
  if (validScenes.length < scenes.length) {
    console.log(`âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${scenes.length - validScenes.length} Ù…Ø´Ù‡Ø¯ ÙŠØªØ¬Ø§ÙˆØ² Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ`);
  }
  
  if (validScenes.length === 0) {
    console.error("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ ØµØ§Ù„Ø­Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù†Øµ");
    process.exit(1);
  }
  
  const sceneVideos = [];
  
  for (let i = 0; i < validScenes.length; i++) {
    const scene = validScenes[i];
    console.log(`\nğŸ¬ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø´Ù‡Ø¯ ${i + 1}/${validScenes.length}`);
    console.log(`   â±ï¸  ${Math.floor(scene.start/60)}:${Math.floor(scene.start%60).toString().padStart(2,'0')} - ${Math.floor(scene.end/60)}:${Math.floor(scene.end%60).toString().padStart(2,'0')}`);
    console.log(`   ğŸ“ ${scene.text.substring(0, 100)}${scene.text.length > 100 ? '...' : ''}`);
    
    const voicePath = `temp/voice_${i}.mp3`;
    await generateArabicVoiceover(scene.text, `temp/voice_${i}`);
    
    const clipPath = `temp/clip_${i}.mp4`;
    cutVideoSegment(videoPath, scene.start, scene.duration, clipPath);
    
    const finalScenePath = `temp/scene_${i}.mp4`;
    applyCinematicEffects(clipPath, voicePath, finalScenePath);
    
    sceneVideos.push(finalScenePath);
  }
  
  console.log("\nğŸ”— Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯...");
  const timestamp = new Date().getTime();
  const finalVideo = `output/final_summary_${timestamp}.mp4`;
  concatVideos(sceneVideos, finalVideo);
  
  const finalInfo = getVideoInfo(finalVideo);
  const finalMinutes = Math.floor(finalInfo.duration / 60);
  const finalSeconds = Math.floor(finalInfo.duration % 60);
  console.log(`\nâœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:`);
  console.log(`   ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø±: ${finalVideo}`);
  console.log(`   â±ï¸  Ø§Ù„Ù…Ø¯Ø©: ${finalMinutes}:${finalSeconds.toString().padStart(2, '0')}`);
  console.log(`   ğŸ“¦ Ø§Ù„Ø­Ø¬Ù…: ${(finalInfo.size / (1024*1024)).toFixed(2)} MB`);
  console.log(`   ğŸ¬ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯: ${validScenes.length}`);
  
  cleanup();
  
  console.log("\nâœ¨ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
}

if (require.main === module) {
  main().catch(error => {
    console.error("âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", error);
    process.exit(1);
  });
}

module.exports = {
  downloadFromUrl,
  parseScriptFile,
  timeToSeconds,
  generateArabicVoiceover,
  cutVideoSegment,
  applyCinematicEffects,
  concatVideos,
  getVideoInfo,
  cleanup,
  main
};
