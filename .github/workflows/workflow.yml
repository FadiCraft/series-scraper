name: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ

on:
  workflow_dispatch:  # ÙŠØªÙŠØ­ Ù„Ùƒ ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
    inputs:
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'
        required: true
      script_file:
        description: 'Ù…Ù„Ù Ø§Ù„Ù†Øµ'
        required: true
        default: 'script.txt'
      audio_file:
        description: 'Ù…Ù„Ù Ø§Ù„ØµÙˆØª'
        required: true
        default: 'Sund.mp3'

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      
    - name: âš¡ Cache FFmpeg
      id: cache-ffmpeg
      uses: actions/cache@v3
      with:
        path: ~/ffmpeg
        key: ${{ runner.os }}-ffmpeg-6.1
        
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª FFmpeg (Ù…Ø®Ø²Ù†)
      if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/ffmpeg
        wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
        tar -xf ffmpeg-release-amd64-static.tar.xz -C ~/ffmpeg --strip-components=1
        rm ffmpeg-release-amd64-static.tar.xz
        
    - name: ğŸ”§ Ø¥Ø¶Ø§ÙØ© FFmpeg Ø¥Ù„Ù‰ PATH
      run: |
        echo "$HOME/ffmpeg" >> $GITHUB_PATH
        echo "$HOME/ffmpeg" >> ~/.bashrc
        
    - name: âš¡ Cache Node Modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¥ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…
      run: npm ci || npm install
      
    - name: ğŸ“ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª
      run: |
        mkdir -p output temp downloads
        
    - name: ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
      run: |
        echo "=== Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ==="
        ls -la
        echo "=== Ù…Ø­ØªÙˆÙ‰ script.txt ==="
        cat script.txt || echo "Ù…Ù„Ù script.txt ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
        
    - name: ğŸ¬ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
      run: |
        time node processor.js "${{ github.event.inputs.video_url }}" "${{ github.event.inputs.script_file }}" "${{ github.event.inputs.audio_file }}"
        
    - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ø§ØªØ¬
      uses: actions/upload-artifact@v4
      with:
        name: Ø§Ù„ÙÙŠØ¯ÙŠÙˆ-Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        path: output/*.mp4
        retention-days: 7
        
    - name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ
      if: always()
      run: |
        rm -rf temp/*
        echo "âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"
