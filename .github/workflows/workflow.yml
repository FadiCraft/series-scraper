name: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ

on:
  workflow_dispatch:  # ÙŠØªÙŠØ­ Ù„Ùƒ ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
    inputs:
      video_url:
        description: 'ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'
        required: true

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      
    - name: âš¡ Cache FFmpeg
      id: cache-ffmpeg
      uses: actions/cache@v3
      with:
        path: ~/ffmpeg
        key: ${{ runner.os }}-ffmpeg-6.1
        
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª FFmpeg (Ù…Ø®Ø²Ù†)
      if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/ffmpeg
        wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
        tar -xf ffmpeg-release-amd64-static.tar.xz -C ~/ffmpeg --strip-components=1
        rm ffmpeg-release-amd64-static.tar.xz
        
    - name: ğŸ”§ Ø¥Ø¶Ø§ÙØ© FFmpeg Ø¥Ù„Ù‰ PATH
      run: |
        echo "$HOME/ffmpeg" >> $GITHUB_PATH
        echo "$HOME/ffmpeg" >> ~/.bashrc
        
    - name: âš¡ Cache Node Modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¥ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù…
      run: npm ci || npm install
      
    - name: ğŸ“ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª
      run: |
        mkdir -p output temp downloads
        
    - name: ğŸ“ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      run: |
        echo "=== ğŸ“„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ==="
        ls -la
        echo ""
        echo "=== ğŸ“ Ù…Ø­ØªÙˆÙ‰ script.txt ==="
        if [ -f "script.txt" ]; then
          cat script.txt
          echo ""
          echo "âœ… Ù…Ù„Ù script.txt Ù…ÙˆØ¬ÙˆØ¯"
        else
          echo "âŒ Ù…Ù„Ù script.txt ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
          exit 1
        fi
        echo ""
        echo "=== ğŸµ Ù…Ù„Ù Ø§Ù„ØµÙˆØª ==="
        if [ -f "Sund.mp3" ]; then
          echo "âœ… Ù…Ù„Ù Sund.mp3 Ù…ÙˆØ¬ÙˆØ¯"
          echo "Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $(du -h Sund.mp3 | cut -f1)"
        else
          echo "âŒ Ù…Ù„Ù Sund.mp3 ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
          exit 1
        fi
        
    - name: ğŸ¬ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©..."
        echo "ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: ${{ github.event.inputs.video_url }}"
        echo "ğŸ“ Ù…Ù„Ù Ø§Ù„Ù†Øµ: script.txt"
        echo "ğŸµ Ù…Ù„Ù Ø§Ù„ØµÙˆØª: Sund.mp3"
        echo ""
        time node processor.js "${{ github.event.inputs.video_url }}" "script.txt" "Sund.mp3"
        
    - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ø§ØªØ¬
      uses: actions/upload-artifact@v4
      with:
        name: Ø§Ù„ÙÙŠØ¯ÙŠÙˆ-Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        path: output/*.mp4
        retention-days: 7
        
    - name: ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: success()
      run: |
        echo ""
        echo "âœ…âœ…âœ… ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­! âœ…âœ…âœ…"
        echo ""
        echo "ğŸ“ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ø¬Ù„Ø¯ output/"
        ls -la output/
        echo ""
        echo "ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: $(du -h output/*.mp4 | cut -f1)"
        
    - name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ
      if: always()
      run: |
        rm -rf temp/*
        echo "âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"
