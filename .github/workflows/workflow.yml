name: Video Processing Pipeline

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (mp4)'
        required: true
        default: 'https://example.com/video.mp4'
      audio_url:
        description: 'Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø§Ù„ØµÙˆØª (mp3) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ'
        required: false
        default: ''
  push:
    branches: [ main ]
    paths:
      - 'script.txt'
      - 'input/sound.mp3'

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      uses: actions/checkout@v4
    
    - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ØªØ«Ø¨ÙŠØª FFmpeg ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg wget curl
        ffmpeg -version
    
    - name: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      run: |
        mkdir -p input temp_clips output
    
    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
      run: |
        echo "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù†: ${{ github.event.inputs.video_url }}"
        if [ -z "${{ github.event.inputs.video_url }}" ] && [ -f "input/video.mp4" ]; then
          echo "âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ: input/video.mp4"
        else
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
          VIDEO_URL="${{ github.event.inputs.video_url }}"
          if [ -z "$VIDEO_URL" ]; then
            echo "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ"
            exit 1
          fi
          # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
          wget -O input/video.mp4 "$VIDEO_URL" || curl -L -o input/video.mp4 "$VIDEO_URL"
          if [ ! -f "input/video.mp4" ] || [ ! -s "input/video.mp4" ]; then
            echo "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"
            exit 1
          fi
          echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­"
        fi
    
    - name: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
      run: |
        if [ ! -z "${{ github.event.inputs.audio_url }}" ]; then
          echo "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù†: ${{ github.event.inputs.audio_url }}"
          wget -O input/sound.mp3 "${{ github.event.inputs.audio_url }}" || curl -L -o input/sound.mp3 "${{ github.event.inputs.audio_url }}"
          if [ -f "input/sound.mp3" ] && [ -s "input/sound.mp3" ]; then
            echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­"
          else
            echo "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØªØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯"
          fi
        else
          echo "ğŸ“ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ù† input/sound.mp3 (Ø¥Ù† ÙˆØ¬Ø¯)"
        fi
    
    - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      run: |
        echo "ğŸ“ Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ø¬Ù„Ø¯ input:"
        ls -la input/
        
        if [ ! -f "input/video.mp4" ]; then
          echo "âŒ Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          exit 1
        fi
        
        if [ ! -f "script.txt" ]; then
          echo "âŒ Ù…Ù„Ù script.txt ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          exit 1
        fi
        
        # Ø§Ù„ØµÙˆØª Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        if [ ! -f "input/sound.mp3" ]; then
          echo "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ØµÙˆØªØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"
        fi
        
        echo "âœ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©"
    
    - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
      run: |
        npm init -y
        npm install fluent-ffmpeg
    
    - name: ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
      run: node processor.js
      continue-on-error: false
    
    - name: Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ø§ØªØ¬
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: video-summary-${{ github.run_number }}
        path: output/final_summary.mp4
        retention-days: 7
    
    - name: Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ (ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-files-${{ github.run_number }}
        path: |
          input/
          temp_clips/
          script.txt
          *.log
        retention-days: 3
